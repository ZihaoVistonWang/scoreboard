<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房间 {{ room_id }} - 赛事积分器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>房间: {{ room_id }}</h1>
            <a href="/" class="btn back-btn">返回首页</a>
        </header>
        
        <div class="card">
            <h2>积分列表</h2>
            <div class="user-list" id="user-list">
                {% for user in users %}
                <div class="user-item {% if user.id == current_user.id %}current-user{% endif %}" 
                     data-user-id="{{ user.id }}" 
                     data-username="{{ user.name }}">
                    <div class="user-name">{{ user.name }}</div>
                    <div class="user-score">{{ user.score }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Transfer modal -->
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>转账给 <span id="recipient-name"></span></h2>
            <div class="form-group">
                <label for="transfer-amount">金额</label>
                <input type="number" id="transfer-amount" min="1" value="1">
            </div>
            <div class="button-group">
                <button id="confirm-transfer" class="btn">确认</button>
                <button id="cancel-transfer" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userList = document.getElementById('user-list');
            const transferModal = document.getElementById('transfer-modal');
            const closeModal = document.querySelector('.close-modal');
            const cancelTransfer = document.getElementById('cancel-transfer');
            const confirmTransfer = document.getElementById('confirm-transfer');
            const recipientName = document.getElementById('recipient-name');
            const transferAmount = document.getElementById('transfer-amount');
            
            const currentUserId = '{{ current_user.id }}';
            const roomId = '{{ room_id }}';
            
            let selectedUserId = null;
            let lastUpdateTime = Date.now();
            let updateInterval;
            
            // Show transfer modal when clicking on another user
            userList.addEventListener('click', function(event) {
                const userItem = event.target.closest('.user-item');
                if (!userItem) return;
                
                const userId = userItem.dataset.userId;
                
                // Don't allow transfers to self
                if (userId === currentUserId) return;
                
                selectedUserId = userId;
                recipientName.textContent = userItem.dataset.username;
                transferModal.style.display = 'block';
                transferAmount.focus();
            });
            
            // Close modal
            function closeTransferModal() {
                transferModal.style.display = 'none';
                selectedUserId = null;
            }
            
            closeModal.addEventListener('click', closeTransferModal);
            cancelTransfer.addEventListener('click', closeTransferModal);
            
            // Handle transfer submission
            confirmTransfer.addEventListener('click', function() {
                const amount = parseInt(transferAmount.value, 10);
                if (isNaN(amount) || amount <= 0) {
                    alert('请输入有效金额');
                    return;
                }
                
                fetch('/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `room_id=${encodeURIComponent(roomId)}&from_user_id=${encodeURIComponent(currentUserId)}&to_user_id=${encodeURIComponent(selectedUserId)}&amount=${encodeURIComponent(amount)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new scores
                        updateScores(data.users);
                        closeTransferModal();
                        lastUpdateTime = Date.now();
                    } else {
                        alert('转账失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error during transfer:', error);
                    alert('转账过程中出错，请重试');
                });
            });
            
            // Update scores in the UI
            function updateScores(users) {
                const userItems = userList.querySelectorAll('.user-item');
                
                userItems.forEach(item => {
                    const userId = item.dataset.userId;
                    const userScoreElement = item.querySelector('.user-score');
                    
                    // Find the updated user data
                    const updatedUser = users.find(u => u.id === userId);
                    if (updatedUser) {
                        userScoreElement.textContent = updatedUser.score;
                    }
                });
            }
            
            // Fetch updated room data periodically
            function startPolling() {
                updateInterval = setInterval(fetchRoomData, 5000); // Check for updates every 5 seconds (changed from 3)
            }
            
            function fetchRoomData() {
                fetch(`/get_room_data/${roomId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Check if user count has changed, which means someone joined or left
                            const currentUserCount = userList.querySelectorAll('.user-item').length;
                            
                            if (data.user_count !== currentUserCount) {
                                // If the number of users has changed, reload the page to get the updated user list
                                location.reload();
                            } else {
                                // Just update the scores
                                updateScores(data.users);
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching room data:', error));
            }
            
            // Start polling for updates
            startPolling();
        });
    </script>
</body>
</html>
