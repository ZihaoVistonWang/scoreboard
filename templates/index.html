<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>赛事积分板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>赛事积分板</h1>
        
        <div class="card">
            <div class="form-group">
                <label for="room-id">赛事号</label>
                <div class="dropdown">
                    <input type="text" id="room-id" placeholder="选择或添加赛事" readonly>
                    <div class="dropdown-content" id="room-dropdown">
                        <!-- Room list will be populated here -->
                        <div class="dropdown-item add-new" id="add-new-room">添加赛事...</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="username">用户名</label>
                <div class="dropdown">
                    <input type="text" id="username" placeholder="选择或添加用户" readonly>
                    <div class="dropdown-content" id="username-dropdown">
                        <!-- User list will be populated here -->
                        <div class="dropdown-item add-new" id="add-new-user">添加用户...</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group" id="initial-score-container" style="display: none;">
                <label for="initial-score">初始积分</label>
                <input type="number" id="initial-score" value="50" min="0">
            </div>
            
            <div class="button-group">
                <button id="watch-btn" class="btn" disabled>观看赛事</button>
                <button id="join-btn" class="btn" disabled>加入赛事</button>
                <button id="create-btn" class="btn" disabled>创建赛事</button>
            </div>
        </div>
    </div>

    <!-- Add new user modal -->
    <div id="new-user-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>添加新用户</h2>
            <div class="form-group">
                <label for="new-username">用户名</label>
                <input type="text" id="new-username" placeholder="输入新用户名">
            </div>
            <button id="confirm-new-user" class="btn">确认</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const roomIdInput = document.getElementById('room-id');
            const roomDropdown = document.getElementById('room-dropdown');
            const addNewRoomItem = document.getElementById('add-new-room');
            const usernameInput = document.getElementById('username');
            const usernameDropdown = document.getElementById('username-dropdown');
            const addNewUserItem = document.getElementById('add-new-user');
            const watchBtn = document.getElementById('watch-btn');
            const joinBtn = document.getElementById('join-btn');
            const createBtn = document.getElementById('create-btn');
            
            // Modal elements
            const newUserModal = document.getElementById('new-user-modal');
            const closeModal = document.querySelector('.close-modal');
            const newUsernameInput = document.getElementById('new-username');
            const confirmNewUserBtn = document.getElementById('confirm-new-user');
            
            let selectedUsername = '';
            let roomExists = false;
            
            // Load rooms on page load
            loadRooms();
            
            // Toggle dropdowns when clicking on inputs
            roomIdInput.addEventListener('click', function() {
                roomDropdown.style.display = 
                    roomDropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            usernameInput.addEventListener('click', function() {
                usernameDropdown.style.display = 
                    usernameDropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.dropdown')) {
                    roomDropdown.style.display = 'none';
                    usernameDropdown.style.display = 'none';
                }
            });
            
            // Handle "Add new room" option
            addNewRoomItem.addEventListener('click', function() {
                roomIdInput.readOnly = false;
                roomIdInput.focus();
                roomDropdown.style.display = 'none';
            });
            
            // Handle "Add new user" option
            addNewUserItem.addEventListener('click', function() {
                newUserModal.style.display = 'block';
                usernameDropdown.style.display = 'none';
                newUsernameInput.focus();
            });
            
            // Close modal
            closeModal.addEventListener('click', function() {
                newUserModal.style.display = 'none';
            });
            
            // Confirm new username
            confirmNewUserBtn.addEventListener('click', function() {
                const newUsername = newUsernameInput.value.trim();
                if (newUsername) {
                    usernameInput.value = newUsername;
                    selectedUsername = newUsername;
                    newUserModal.style.display = 'none';
                    updateButtons();
                }
            });
            
            // When selecting a username from dropdown
            function selectUsername(name) {
                usernameInput.value = name;
                selectedUsername = name;
                usernameDropdown.style.display = 'none';
                updateButtons();
            }
            
            // Watch room action
            watchBtn.addEventListener('click', function() {
                submitForm('watch_room');
            });
            
            // Join room action
            joinBtn.addEventListener('click', function() {
                submitForm('join_room');
            });
            
            // Create room action
            createBtn.addEventListener('click', function() {
                submitForm('create_room');
            });
            
            function submitForm(action) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/' + action;
                
                const roomIdField = document.createElement('input');
                roomIdField.type = 'hidden';
                roomIdField.name = 'room_id';
                roomIdField.value = roomIdInput.value;
                
                const usernameField = document.createElement('input');
                usernameField.type = 'hidden';
                usernameField.name = 'username';
                usernameField.value = selectedUsername;
                
                form.appendChild(roomIdField);
                form.appendChild(usernameField);
                
                // Add initial score if creating a room
                if (action === 'create_room') {
                    const initialScoreField = document.createElement('input');
                    initialScoreField.type = 'hidden';
                    initialScoreField.name = 'initial_score';
                    initialScoreField.value = document.getElementById('initial-score').value;
                    form.appendChild(initialScoreField);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
            
            function updateButtons() {
                const initialScoreContainer = document.getElementById('initial-score-container');
                const roomId = roomIdInput.value.trim();
                
                // Reset all buttons to disabled state
                watchBtn.setAttribute('disabled', true);
                joinBtn.setAttribute('disabled', true);
                createBtn.setAttribute('disabled', true);
                initialScoreContainer.style.display = 'none';
                
                if (!roomId) {
                    return;
                }
                
                if (roomExists) {
                    // Enable watch button if room exists, regardless of username
                    watchBtn.removeAttribute('disabled');
                    
                    // Enable join button only if username is selected
                    if (selectedUsername) {
                        joinBtn.removeAttribute('disabled');
                    }
                } else if (selectedUsername) {
                    // Enable create button if room doesn't exist and username is selected
                    createBtn.removeAttribute('disabled');
                    initialScoreContainer.style.display = 'block';
                }
            }
            
            function checkRoom() {
                const roomId = roomIdInput.value.trim();
                if (!roomId) {
                    return;
                }
                
                // Clear dropdown except "Add new user" option
                Array.from(usernameDropdown.children).forEach(child => {
                    if (!child.classList.contains('add-new')) {
                        child.remove();
                    }
                });
                
                fetch('/check_room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `room_id=${encodeURIComponent(roomId)}`
                })
                .then(response => response.json())
                .then(data => {
                    roomExists = data.exists;
                    
                    if (data.exists && data.users.length > 0) {
                        // Add users to dropdown
                        data.users.forEach(user => {
                            const option = document.createElement('div');
                            option.classList.add('dropdown-item');
                            option.textContent = user;
                            option.addEventListener('click', () => selectUsername(user));
                            usernameDropdown.insertBefore(option, addNewUserItem);
                        });
                    }
                    
                    updateButtons();
                })
                .catch(error => console.error('Error checking room:', error));
            }
            
            // Load rooms from server
            function loadRooms() {
                fetch('/get_rooms')
                    .then(response => response.json())
                    .then(rooms => {
                        // Clear dropdown except "Add new room" option
                        Array.from(roomDropdown.children).forEach(child => {
                            if (!child.classList.contains('add-new')) {
                                child.remove();
                            }
                        });
                        
                        // Add rooms to dropdown
                        rooms.forEach(room => {
                            const option = document.createElement('div');
                            option.classList.add('dropdown-item');
                            option.textContent = room.id;
                            option.addEventListener('click', () => {
                                roomIdInput.value = room.id;
                                roomIdInput.readOnly = true;
                                roomDropdown.style.display = 'none';
                                checkRoom();
                            });
                            roomDropdown.insertBefore(option, addNewRoomItem);
                        });
                    })
                    .catch(error => console.error('Error loading rooms:', error));
            }
        });
    </script>
</body>
</html>
