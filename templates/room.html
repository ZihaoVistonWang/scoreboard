<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿é—´ {{ room_id }} - èµ›äº‹ç§¯åˆ†æ¿</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>æˆ¿é—´: {{ room_id }}</h1>
            <a href="/" class="btn back-btn">è¿”å›é¦–é¡µ</a>
        </header>

        <div class="card">
            <h2>ç§¯åˆ†åˆ—è¡¨</h2>
            <div class="score-table">
                <div class="table-header">
                    <div class="header-name">ç”¨æˆ·å</div>
                    <div class="header-change">ä¸Šå±€å˜åŒ–</div>
                    <div class="header-score">æ€»ç§¯åˆ†</div>
                    <div class="header-rank">æ’å</div>
                </div>
                <div class="user-list" id="user-list">
                    {% for user in users %}
                    <div class="user-item {% if user.id == current_user.id %}current-user{% endif %}" 
                         data-user-id="{{ user.id }}" 
                         data-username="{{ user.name }}">
                        <div class="user-name">
                            {{ user.name }}
                            {% if user.owner %}ğŸ‘‘{% endif %}
                        </div>
                        <div class="user-last-change">{% if user.last_change > 0 %}+{% endif %}{{ user.last_change or 0 }}</div>
                        <div class="user-score">{{ user.score }}</div>
                        <div class="user-rank"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if current_user.owner %}
            <div class="owner-controls">
                <button id="next-round" class="btn">ä¸‹ä¸€å±€</button>
                <button id="settlement" class="btn">ç»“ç®—</button>
            </div>
            {% endif %}

            <div id="settlement-reports" class="settlement-reports">
                {% for report in room_data.get('settlement_reports', []) %}
                <div class="settlement-report">
                    <div class="settlement-header">æˆ¿é—´å·ï¼š{{ room_id }}çš„ç¬¬{{ report.count }}æ¬¡ç»“ç®—æŠ¥å‘Š</div>
                    <div class="settlement-content">{{ report.report | replace('\n', '<br>') | safe }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Transfer modal -->
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>è½¬è´¦ç»™ <span id="recipient-name"></span></h2>
            <div class="form-group">
                <label for="transfer-amount">é‡‘é¢</label>
                <input type="number" id="transfer-amount" min="1" value="1">
            </div>
            <div class="button-group">
                <button id="confirm-transfer" class="btn">ç¡®è®¤</button>
                <button id="cancel-transfer" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userList = document.getElementById('user-list');
            const transferModal = document.getElementById('transfer-modal');
            const closeModal = document.querySelector('.close-modal');
            const cancelTransfer = document.getElementById('cancel-transfer');
            const confirmTransfer = document.getElementById('confirm-transfer');
            const recipientName = document.getElementById('recipient-name');
            const transferAmount = document.getElementById('transfer-amount');

            const currentUserId = '{{ current_user.id }}';
            const roomId = '{{ room_id }}';

            let selectedUserId = null;
            let lastUpdateTime = Date.now();
            let updateInterval;

            // Show transfer modal when clicking on another user
            userList.addEventListener('click', function(event) {
                const userItem = event.target.closest('.user-item');
                if (!userItem) return;

                const userId = userItem.dataset.userId;

                // Don't allow transfers to self
                if (userId === currentUserId) return;

                selectedUserId = userId;
                recipientName.textContent = userItem.dataset.username;
                transferModal.style.display = 'block';
                transferAmount.focus();
            });
            
            // Close modal
            function closeTransferModal() {
                transferModal.style.display = 'none';
                selectedUserId = null;
            }
            
            closeModal.addEventListener('click', closeTransferModal);
            cancelTransfer.addEventListener('click', closeTransferModal);
            
            // Handle transfer submission
            confirmTransfer.addEventListener('click', function() {
                const amount = parseInt(transferAmount.value, 10);
                if (isNaN(amount) || amount <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                    return;
                }
                
                fetch('/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `room_id=${encodeURIComponent(roomId)}&from_user_id=${encodeURIComponent(currentUserId)}&to_user_id=${encodeURIComponent(selectedUserId)}&amount=${encodeURIComponent(amount)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new scores
                        updateScores(data.users);
                        closeTransferModal();
                        lastUpdateTime = Date.now();
                    } else {
                        alert('è½¬è´¦å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error during transfer:', error);
                    alert('è½¬è´¦è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œè¯·é‡è¯•');
                });
            });
            
            // Update scores and ranks in the UI
            function updateScores(users) {
                // Sort users by score
                const sortedUsers = [...users].sort((a, b) => b.score - a.score);
                
                const userItems = userList.querySelectorAll('.user-item');
                userItems.forEach(item => {
                    const userId = item.dataset.userId;
                    const updatedUser = users.find(u => u.id === userId);
                    if (updatedUser) {
                        // Update user name and owner status
                        const nameElement = item.querySelector('.user-name');
                        nameElement.textContent = updatedUser.name;
                        if (updatedUser.owner) {
                            nameElement.textContent += 'ğŸ‘‘';
                        }
                        
                        // Update score and last change
                        item.querySelector('.user-score').textContent = updatedUser.score;
                        const lastChange = updatedUser.last_change || 0;
                        item.querySelector('.user-last-change').textContent = lastChange > 0 ? `+${lastChange}` : lastChange;
                        
                        // Update rank
                        const rank = sortedUsers.findIndex(u => u.id === userId) + 1;
                        const rankElement = item.querySelector('.user-rank');
                        if (rank === 1) rankElement.textContent = 'ğŸ¥‡';
                        else if (rank === 2) rankElement.textContent = 'ğŸ¥ˆ';
                        else if (rank === 3) rankElement.textContent = 'ğŸ¥‰';
                        else rankElement.textContent = rank;
                    }
                });
            }
            
            // Handle next round button
            const nextRoundBtn = document.getElementById('next-round');
            if (nextRoundBtn) {
                nextRoundBtn.addEventListener('click', function() {
                    fetch('/next_round', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `room_id=${encodeURIComponent(roomId)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateScores(data.users);
                        } else {
                            alert('æ“ä½œå¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                });
            }
            
            // Handle settlement button
            const settlementBtn = document.getElementById('settlement');
            if (settlementBtn) {
                settlementBtn.addEventListener('click', function() {
                    fetch('/settle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `room_id=${encodeURIComponent(roomId)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update scores
                            updateScores(data.users);
                            
                            // Add new settlement report
                            const reportsDiv = document.getElementById('settlement-reports');
                            const reportDiv = document.createElement('div');
                            reportDiv.className = 'settlement-report';
                            
                            const header = document.createElement('div');
                            header.className = 'settlement-header';
                            header.textContent = `æˆ¿é—´å·ï¼š${roomId}çš„ç¬¬${data.settlement_count}æ¬¡ç»“ç®—æŠ¥å‘Š`;
                            
                            const content = document.createElement('div');
                            content.className = 'settlement-content';
                            content.innerHTML = data.report.replace(/\n/g, '<br>');
                            
                            reportDiv.appendChild(header);
                            reportDiv.appendChild(content);
                            reportsDiv.insertBefore(reportDiv, reportsDiv.firstChild);
                        } else {
                            alert('ç»“ç®—å¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ç»“ç®—å¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                });
            }
            
            // Fetch updated room data periodically
            function startPolling() {
                updateInterval = setInterval(fetchRoomData, 5000); // Check for updates every 5 seconds (changed from 3)
            }
            
            function fetchRoomData() {
                fetch(`/get_room_data/${roomId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Check if user count has changed, which means someone joined or left
                            const currentUserCount = userList.querySelectorAll('.user-item').length;
                            
                            if (data.user_count !== currentUserCount) {
                                // If the number of users has changed, reload the page to get the updated user list
                                location.reload();
                            } else {
                                // Update scores
                                updateScores(data.users);
                                
                                // Update settlement reports if they've changed
                                if (data.settlement_reports) {
                                    const reportsDiv = document.getElementById('settlement-reports');
                                    reportsDiv.innerHTML = '';  // Clear existing reports
                                    data.settlement_reports.forEach(report => {
                                        const reportDiv = document.createElement('div');
                                        reportDiv.className = 'settlement-report';
                                        
                                        const header = document.createElement('div');
                                        header.className = 'settlement-header';
                                        header.textContent = `æˆ¿é—´å·ï¼š${roomId}çš„ç¬¬${report.count}æ¬¡ç»“ç®—æŠ¥å‘Š`;
                                        
                                        const content = document.createElement('div');
                                        content.className = 'settlement-content';
                                        content.innerHTML = report.report.replace(/\n/g, '<br>');
                                        
                                        reportDiv.appendChild(header);
                                        reportDiv.appendChild(content);
                                        reportsDiv.insertBefore(reportDiv, reportsDiv.firstChild);
                                    });
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching room data:', error));
            }
            
            // Start polling for updates
            startPolling();
        });
    </script>
</body>
</html>
