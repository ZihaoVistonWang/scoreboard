<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ›äº‹å·: {{ room_id }} - èµ›äº‹ç§¯åˆ†æ¿</title>
    
    <!-- å…ƒæ•°æ® -->
    <meta name="room-id" content="{{ room_id }}">
    <meta name="current-user-id" content="{{ current_user.id }}">
    <meta name="is-spectator" content="{{ is_spectator }}">
    <meta name="is-zero-sum" content="{{ is_zero_sum }}">
    <meta name="is-owner" content="{{ current_user.owner }}">
    <meta name="round" content="{{ room_data.get('round', '1') }}">
    <meta name="settle-round" content="{{ room_data.get('settle_round', '1') }}">
    
    <!-- æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/room.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>èµ›äº‹å·: {{ room_id }}{% if is_spectator %} <span style="font-size: 0.7em; color: #666;">(è®¿å®¢æ¨¡å¼)</span>{% endif %}</h1>
            <a href="/" class="btn back-btn">è¿”å›é¦–é¡µ</a>
        </header>

        <div class="card">
            <h2>ç§¯åˆ†åˆ—è¡¨</h2>
            <div class="score-table">
                <div class="table-header">
                    <div class="header-name">ç”¨æˆ·å</div>
                    <div class="header-change">ä¸Šå±€å˜åŒ–</div>
                    <div class="header-score">æ€»ç§¯åˆ†</div>
                    <div class="header-rank">æ’å</div>
                </div>
                <div class="user-list" id="user-list">
                    {% for user in users %}
                    <div class="user-item {% if user.id == current_user.id %}current-user{% endif %}" 
                         data-user-id="{{ user.id }}" 
                         data-username="{{ user.name }}">
                        <div class="user-name">
                            {{ user.name }}
                            {% if user.owner %}ğŸ‘‘{% endif %}
                        </div>
                        <div class="user-last-change">{% if user.last_change > 0 %}+{% endif %}{{ user.last_change or 0 }}</div>
                        <div class="user-score">{{ user.score }}</div>
                        <div class="user-rank"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if not is_spectator %}
                {% if current_user.owner %}
                <div class="button-group">
                    {% if is_zero_sum %}
                    <button id="show-logs" class="btn">æœ¬å±€è®°å½•</button>
                    <button id="show-chart" class="btn">ç§¯åˆ†å˜åŒ–å›¾</button>
                    {% endif %}
                    <button id="next-round" class="btn" {% if not room_data.get('can_next_round', False) %}disabled{% endif %}>ä¸‹ä¸€å±€</button>
                    <button id="settlement" class="btn" {% if not room_data.get('can_settle', False) %}disabled{% endif %}>ç»“ç®—</button>
                </div>
                {% else %}
                {% if is_zero_sum %}
                <div class="button-group">
                    <button id="show-logs" class="btn">æœ¬å±€è®°å½•</button>
                    <button id="show-chart" class="btn">ç§¯åˆ†å˜åŒ–å›¾</button>
                </div>
                {% endif %}
                {% endif %}
            {% else %}
                <div style="margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 14px; color: #666;">
                    è®¿å®¢æ¨¡å¼ä¸‹ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å®æ—¶ç§¯åˆ†å’Œç»“ç®—æŠ¥å‘Šï¼Œä½†æ— æ³•è¿›è¡Œä»»ä½•æ“ä½œã€‚
                </div>
            {% endif %}

            <!-- æœ¬å±€è®°å½•åŒºåŸŸ -->
            <div id="user-logs-section" style="display: none;">
                <h2>æœ¬å±€è®°å½•</h2>
                <div id="user-logs" class="user-logs" style="font-size: 80%;">
                    <!-- ç”¨æˆ·æ—¥å¿—å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>

            <!-- ç§¯åˆ†å˜åŒ–å›¾åŒºåŸŸ -->
            <div id="score-chart-section" style="display: none;">
                <h2>ç§¯åˆ†å˜åŒ–å›¾</h2>
                <div id="score-charts" class="score-charts">
                    <!-- ç§¯åˆ†å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>

            <div id="settlement-reports-section" style="display: none;">
                <h2>ç»“ç®—æŠ¥å‘Š</h2>
                <div id="settlement-reports" class="settlement-reports">
                    {% for report in room_data.get('settlement_reports', []) %}
                    <div class="settlement-report">
                        <div class="settlement-header collapsed">ç¬¬{{ report.count }}è½®ç»“ç®—æŠ¥å‘Š ({{ report.timestamp }})</div>
                        <div class="settlement-content collapsed">{{ report.report | replace('\n', '<br>') | safe }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer modal -->
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>è½¬è´¦ç»™ <span id="recipient-name"></span></h2>
            <div class="form-group">
                <label for="transfer-amount">ç§¯åˆ†</label>
                <input type="number" id="transfer-amount" min="1">
            </div>
            <div class="button-group">
                <button id="confirm-transfer" class="btn">ç¡®è®¤</button>
                <button id="cancel-transfer" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬ -->
    <script src="{{ url_for('static', filename='js/chart-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/logs-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/room-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/settlement.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
<footer style="width: 100%; text-align: center; font-size: 12px; color: #666; margin-top: 20px; position: relative; bottom: 0; left: 0; right: 0;">
    <p>Â© 2025 <a href="https://github.com/ZihaoVistonWang/scoreboard" target="_blank">èµ›äº‹ç§¯åˆ†æ¿</a></p>
    <p>æœ¬åº”ç”¨ç”± <a href="https://github.com/ZihaoVistonWang" target="_blank">ç‹æ¢“è±ª (Zihao Viston Wang)</a> å¼€å‘ | éµå¾ª<a href="https://github.com/ZihaoVistonWang/score-board/blob/main/LICENSE" target="_blank">MIT</a>è®¸å¯å¼€æº.</p>
    {% if 'zihao' in request.host %}
        <p>
            <a href="https://beian.miit.gov.cn/" target="_blank">é™•ICPå¤‡2025060869å·</a>
        </p>
    {% endif %}
</footer>
</html>