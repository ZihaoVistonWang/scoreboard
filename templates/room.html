<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>赛事号: {{ room_id }} - 赛事积分板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* 用户日志相关样式 */
        .user-logs {
            margin: 10px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .round-info {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        
        .user-log-title {
            margin-top: 15px;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px dashed #ddd;
            color: #333;
        }
        
        .log-list {
            list-style-type: none;
            padding: 0;
            margin: 0 0 15px 0;
        }
        
        .log-item {
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }
        
        #show-logs.active {
            background-color: #3271ae;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>赛事号: {{ room_id }}</h1>
            <a href="/" class="btn back-btn">返回首页</a>
        </header>

        <div class="card">
            <h2>积分列表</h2>
            <div class="score-table">
                <div class="table-header">
                    <div class="header-name">用户名</div>
                    <div class="header-change">上局变化</div>
                    <div class="header-score">总积分</div>
                    <div class="header-rank">排名</div>
                </div>
                <div class="user-list" id="user-list">
                    {% for user in users %}
                    <div class="user-item {% if user.id == current_user.id %}current-user{% endif %}" 
                         data-user-id="{{ user.id }}" 
                         data-username="{{ user.name }}">
                        <div class="user-name">
                            {{ user.name }}
                            {% if user.owner %}👑{% endif %}
                        </div>
                        <div class="user-last-change">{% if user.last_change > 0 %}+{% endif %}{{ user.last_change or 0 }}</div>
                        <div class="user-score">{{ user.score }}</div>
                        <div class="user-rank"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if current_user.owner %}
            <div class="owner-controls">
                {% if is_zero_sum %}
                <button id="show-logs" class="btn">本局记录</button>
                {% endif %}
                <button id="next-round" class="btn" {% if not room_data.get('can_next_round', False) %}disabled{% endif %}>下一局</button>
                <button id="settlement" class="btn" {% if not room_data.get('can_settle', False) %}disabled{% endif %}>结算</button>
            </div>
            {% else %}
            {% if is_zero_sum %}
            <div class="owner-controls">
                <button id="show-logs" class="btn">本局记录</button>
            </div>
            {% endif %}
            {% endif %}

            <!-- 本局记录区域 -->
            <div id="user-logs-section" style="display: none;">
                <h2>本局记录</h2>
                <div id="user-logs" class="user-logs" style="font-size: 80%;">
                    <!-- 用户日志将通过JavaScript动态添加 -->
                </div>
            </div>

            <div id="settlement-reports-section" style="display: none;">
                <h2>结算报告</h2>
                <div id="settlement-reports" class="settlement-reports">
                    {% for report in room_data.get('settlement_reports', []) %}
                    <div class="settlement-report">
                        <div class="settlement-header">第{{ report.count }}次结算报告 ({{ report.timestamp }})</div>
                        <div class="settlement-content">{{ report.report | replace('\n', '<br>') | safe }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer modal -->
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>转账给 <span id="recipient-name"></span></h2>
            <div class="form-group">
                <label for="transfer-amount">金额</label>
                <input type="number" id="transfer-amount" min="1">
            </div>
            <div class="button-group">
                <button id="confirm-transfer" class="btn">确认</button>
                <button id="cancel-transfer" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userList = document.getElementById('user-list');
            const transferModal = document.getElementById('transfer-modal');
            const closeModal = document.querySelector('.close-modal');
            const cancelTransfer = document.getElementById('cancel-transfer');
            const confirmTransfer = document.getElementById('confirm-transfer');
            const recipientName = document.getElementById('recipient-name');
            const transferAmount = document.getElementById('transfer-amount');

            const currentUserId = '{{ current_user.id }}';
            const roomId = '{{ room_id }}';

            let selectedUserId = null;
            let lastUpdateTime = Date.now();
            let updateInterval;

            // Show transfer modal when clicking on another user
            userList.addEventListener('click', function(event) {
                const userItem = event.target.closest('.user-item');
                if (!userItem) return;

                const userId = userItem.dataset.userId;
                const username = userItem.dataset.username;

                // Don't show transfer modal for spectators
                if ('{{ is_spectator }}' === 'True') return;

                // For zero-sum rooms:
                // 1. Owner clicking their own name should not show transfer modal
                // 2. Non-owner users can transfer to others (not themselves)
                if ('{{ is_zero_sum }}' === 'True') {
                    if ('{{ current_user.owner }}' === 'True') {
                        // Owner clicking their own name - don't show modal
                        if (userId === currentUserId) return;
                    } else {
                        // Non-owner users can transfer to others (not themselves)
                        if (userId === currentUserId) return;
                    }
                } else {
                    // For non-zero-sum rooms, only owner can transfer
                    if ('{{ current_user.owner }}' !== 'True') return;
                }

                selectedUserId = userId;
                recipientName.textContent = username;
                
                // Update modal title and input label based on game type
                const modalTitle = document.querySelector('#transfer-modal h2');
                const amountLabel = document.querySelector('#transfer-modal label[for="transfer-amount"]');
                
                if ('{{ is_zero_sum }}' === 'True') {
                    modalTitle.textContent = `转账给 ${username}`;
                    amountLabel.textContent = '转账金额';
                    transferAmount.min = '1';
                } else {
                    modalTitle.textContent = `修改 ${username} 的积分`;
                    amountLabel.textContent = '积分变化（正数增加，负数减少）';
                    transferAmount.min = '-999999';  // Allow negative values
                }
                
                transferModal.style.display = 'block';
                transferAmount.focus();
            });
            
            // Close modal
            function closeTransferModal() {
                transferModal.style.display = 'none';
                selectedUserId = null;
            }
            
            closeModal.addEventListener('click', closeTransferModal);
            cancelTransfer.addEventListener('click', closeTransferModal);
            
            // Handle transfer submission
            confirmTransfer.addEventListener('click', function() {
                const amount = parseInt(transferAmount.value, 10);
                if (isNaN(amount)) {
                    alert('请输入有效金额');
                    return;
                }
                
                // For zero-sum games, only allow positive amounts
                if ('{{ is_zero_sum }}' === 'True' && amount <= 0) {
                    alert('请输入大于0的金额');
                    return;
                }
                
                fetch('/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `room_id=${encodeURIComponent(roomId)}&from_user_id=${encodeURIComponent(currentUserId)}&to_user_id=${encodeURIComponent(selectedUserId)}&amount=${encodeURIComponent(amount)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new scores
                        updateScores(data.users);
                        closeTransferModal();
                        lastUpdateTime = Date.now();
                        
                        // Update button states
                        const nextRoundBtn = document.getElementById('next-round');
                        const settlementBtn = document.getElementById('settlement');
                        
                        if (nextRoundBtn && 'can_next_round' in data) {
                            nextRoundBtn.disabled = !data.can_next_round;
                        }
                        
                        if (settlementBtn && 'can_settle' in data) {
                            settlementBtn.disabled = !data.can_settle;
                        }

                        // 更新round和settle_round信息
                        if ('round' in data) {
                            window.currentRound = data.round;
                        }
                        if ('settle_round' in data) {
                            window.currentSettleRound = data.settle_round;
                        }
                    } else {
                        alert('操作失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error during transfer:', error);
                    alert('操作过程中出错，请重试');
                });
            });
            
            // Update scores and ranks in the UI
            function updateScores(users) {
                // Sort users by score
                const sortedUsers = [...users].sort((a, b) => b.score - a.score);
                
                // Get all user items and convert to array for sorting
                const userItemsArray = Array.from(userList.querySelectorAll('.user-item'));
                
                // Sort user items based on user scores
                userItemsArray.sort((a, b) => {
                    const userA = users.find(u => u.id === a.dataset.userId);
                    const userB = users.find(u => u.id === b.dataset.userId);
                    return userB.score - userA.score;
                });
                
                // Reorder DOM elements
                userItemsArray.forEach(item => userList.appendChild(item));
                
                // Update user information
                const userItems = userList.querySelectorAll('.user-item');
                userItems.forEach(item => {
                    const userId = item.dataset.userId;
                    const updatedUser = users.find(u => u.id === userId);
                    if (updatedUser) {
                        // Update user name and owner status
                        const nameElement = item.querySelector('.user-name');
                        nameElement.textContent = updatedUser.name;
                        if (updatedUser.owner) {
                            nameElement.textContent += '👑';
                        }
                        
                        // Update last change
                        const lastChange = updatedUser.last_change || 0;
                        item.querySelector('.user-last-change').textContent = lastChange > 0 ? `+${lastChange}` : lastChange;
                        
                        // 更新总积分显示格式
                        const scoreElement = item.querySelector('.user-score');
                        const lastScore = updatedUser.last_score || updatedUser.score;
                        const scoreDiff = updatedUser.score - lastScore;
                        
                        if (scoreDiff === 0) {
                            // 如果没有变化，直接显示总积分
                            scoreElement.innerHTML = lastScore;
                        } else if (scoreDiff > 0) {
                            // 如果增加，显示蓝色增量
                            scoreElement.innerHTML = `${lastScore}<span style="color:#3271ae; font-size:80%">+${scoreDiff}</span>`;
                        } else {
                            // 如果减少，显示红色减量
                            scoreElement.innerHTML = `${lastScore}<span style="color:#c12c1f; font-size:80%">-${Math.abs(scoreDiff)}</span>`;
                        }
                        
                        // Update rank
                        const rank = sortedUsers.findIndex(u => u.id === userId) + 1;
                        const rankElement = item.querySelector('.user-rank');
                        if (rank === 1) rankElement.textContent = '🥇';
                        else if (rank === 2) rankElement.textContent = '🥈';
                        else if (rank === 3) rankElement.textContent = '🥉';
                        else rankElement.textContent = rank;
                    }
                });

                // 控制结算报告区域的显示
                const reportsSection = document.getElementById('settlement-reports-section');
                const reports = document.getElementById('settlement-reports');
                if (reports && reports.children.length > 0) {
                    reportsSection.style.display = 'block';
                    
                    // 确保结算报告可以折叠/展开
                    if (typeof setupSettlementListeners === 'function') {
                        setupSettlementListeners();
                    }
                } else {
                    reportsSection.style.display = 'none';
                }
            }
            
            // Handle next round button
            const nextRoundBtn = document.getElementById('next-round');
            if (nextRoundBtn) {
                nextRoundBtn.addEventListener('click', function() {
                    fetch('/next_round', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `room_id=${encodeURIComponent(roomId)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateScores(data.users);
                            
                            // Update button states
                            if ('can_next_round' in data) {
                                nextRoundBtn.disabled = !data.can_next_round;
                            }
                            
                            const settlementBtn = document.getElementById('settlement');
                            if (settlementBtn && 'can_settle' in data) {
                                settlementBtn.disabled = !data.can_settle;
                            }
                        } else {
                            alert('操作失败: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('操作失败，请重试');
                    });
                });
            }
            
            // Handle settlement button
            const settlementBtn = document.getElementById('settlement');
            if (settlementBtn) {
                settlementBtn.addEventListener('click', function() {
                    fetch('/settle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `room_id=${encodeURIComponent(roomId)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update scores
                            updateScores(data.users);
                            
                            // Add new settlement report
                            const reportsDiv = document.getElementById('settlement-reports');
                            const reportDiv = document.createElement('div');
                            reportDiv.className = 'settlement-report';
                            
                            const header = document.createElement('div');
                            header.className = 'settlement-header collapsed';
                            header.textContent = `第${data.settlement_count}次结算报告 (${data.timestamp})`;
                            
                            const content = document.createElement('div');
                            content.className = 'settlement-content collapsed';
                            content.innerHTML = data.report.replace(/\n/g, '<br>');
                            
                            reportDiv.appendChild(header);
                            reportDiv.appendChild(content);
                            reportsDiv.insertBefore(reportDiv, reportsDiv.firstChild);
                            
                            // 在添加新报告后，重新初始化折叠/展开功能
                            if (typeof setupSettlementListeners === 'function') {
                                setupSettlementListeners();
                            }
                            
                            // Update button states
                            if ('can_next_round' in data) {
                                nextRoundBtn.disabled = !data.can_next_round;
                            }
                            
                            if ('can_settle' in data) {
                                settlementBtn.disabled = !data.can_settle;
                            }

                            // 更新round和settle_round信息
                            window.currentRound = data.round;
                            window.currentSettleRound = data.settle_round;
                        } else {
                            alert('结算失败: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('结算失败，请重试');
                    });
                });
            }
            
            // Handle show logs button
            const showLogsBtn = document.getElementById('show-logs');
            const userLogsSection = document.getElementById('user-logs-section');
            const userLogs = document.getElementById('user-logs');
            
            if (showLogsBtn) {
                showLogsBtn.addEventListener('click', function() {
                    if (userLogsSection.style.display === 'none') {
                        // 显示日志区域
                        userLogsSection.style.display = 'block';
                        showLogsBtn.textContent = '关闭记录';
                        showLogsBtn.classList.add('active');
                        
                        // 获取并显示用户日志
                        fetchUserLogs();
                    } else {
                        // 隐藏日志区域
                        userLogsSection.style.display = 'none';
                        showLogsBtn.textContent = '本局记录';
                        showLogsBtn.classList.remove('active');
                    }
                });
            }
            
            // 获取用户日志的函数
            function fetchUserLogs() {
                fetch(`/get_user_logs/${roomId}/${currentUserId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayUserLogs(data.logs);
                            
                            // 如果是房主，添加提示
                            if (data.is_owner) {
                                const ownerNote = document.createElement('div');
                                ownerNote.className = 'owner-note';
                                ownerNote.innerHTML = '<em>注：作为房主，您可以查看所有玩家的记录</em>';
                                ownerNote.style.fontSize = '80%';
                                ownerNote.style.marginTop = '10px';
                                ownerNote.style.color = '#666';
                                userLogs.appendChild(ownerNote);
                            }
                        } else {
                            userLogs.innerHTML = '<p>暂无记录</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user logs:', error);
                        userLogs.innerHTML = '<p>获取记录时出错</p>';
                    });
            }
            
            // 显示用户日志的函数
            function displayUserLogs(logs) {
                userLogs.innerHTML = '';
                
                if (!logs || Object.keys(logs).length === 0) {
                    userLogs.innerHTML = '<p>暂无记录</p>';
                    return;
                }
                
                // 获取当前的结算轮次和回合
                const settleRoundNum = window.currentSettleRound || '{{ room_data.get("settle_round", "1") }}';
                const roundNum = window.currentRound || '{{ room_data.get("round", "1") }}';
                
                // 构造键名
                const settleRoundKey = `settle_${settleRoundNum}`;
                const roundKey = `round_${roundNum}`;
                
                // 在顶部显示当前轮次信息
                const roundInfo = document.createElement('div');
                roundInfo.className = 'round-info';
                roundInfo.innerHTML = `当前：第${settleRoundNum}轮第${roundNum}局`;
                userLogs.appendChild(roundInfo);
                
                // 遍历所有用户的日志
                let hasAnyLogs = false;
                
                // 获取用户列表
                const userNames = Object.keys(logs);
                
                // 遍历每个用户的日志
                userNames.forEach(userName => {
                    const userLogData = logs[userName];
                    
                    // 检查当前轮次的日志是否存在
                    if (userLogData[settleRoundKey] && userLogData[settleRoundKey][roundKey]) {
                        let currentLogs = userLogData[settleRoundKey][roundKey];
                        
                        // 确保currentLogs是数组
                        if (!Array.isArray(currentLogs) || currentLogs.length === 0) {
                            return; // 跳过这个用户
                        }
                        
                        hasAnyLogs = true;
                        
                        // 创建用户标题
                        const userTitle = document.createElement('div');
                        userTitle.className = 'user-log-title';
                        userTitle.innerHTML = `<strong>${userName}的记录</strong>`;
                        userLogs.appendChild(userTitle);
                        
                        // 创建日志列表
                        const logList = document.createElement('ul');
                        logList.className = 'log-list';
                        
                        currentLogs.forEach(log => {
                            const logItem = document.createElement('li');
                            logItem.className = 'log-item';
                            logItem.innerHTML = log.description;
                            
                            // 根据类型添加不同的样式
                            if (log.type === 'in') {
                                logItem.style.color = '#3271ae'; // 收入颜色
                            } else if (log.type === 'out') {
                                logItem.style.color = '#c12c1f'; // 支出颜色
                            }
                            
                            logList.appendChild(logItem);
                        });
                        
                        userLogs.appendChild(logList);
                    }
                });
                
                // 如果没有任何日志，显示提示信息
                if (!hasAnyLogs) {
                    userLogs.innerHTML += '<p>本局暂无记录</p>';
                }
            }
            
            // Fetch updated room data periodically
            function startPolling() {
                updateInterval = setInterval(fetchRoomData, 5000); // Check for updates every 5 seconds (changed from 3)
            }
            
            function fetchRoomData() {
                fetch(`/get_room_data/${roomId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Check if user count has changed, which means someone joined or left
                            const currentUserCount = userList.querySelectorAll('.user-item').length;
                            
                            if (data.user_count !== currentUserCount) {
                                // If the number of users has changed, reload the page to get the updated user list
                                location.reload();
                            } else {
                                // Update scores
                                updateScores(data.users);
                                
                                // Update button states based on flags
                                const nextRoundBtn = document.getElementById('next-round');
                                const settlementBtn = document.getElementById('settlement');
                                
                                if (nextRoundBtn) {
                                    nextRoundBtn.disabled = !data.can_next_round;
                                }
                                
                                if (settlementBtn) {
                                    settlementBtn.disabled = !data.can_settle;
                                }
                                
                                // Update settlement reports if they've changed
                                if (data.settlement_reports) {
                                    const reportsDiv = document.getElementById('settlement-reports');
                                    reportsDiv.innerHTML = '';  // Clear existing reports
                                    data.settlement_reports.forEach(report => {
                                        const reportDiv = document.createElement('div');
                                        reportDiv.className = 'settlement-report';
                                        
                                        const header = document.createElement('div');
                                        header.className = 'settlement-header collapsed';
                                        header.textContent = `第${report.count}次结算报告 (${report.timestamp})`;
                                        
                                        const content = document.createElement('div');
                                        content.className = 'settlement-content collapsed';
                                        content.innerHTML = report.report.replace(/\n/g, '<br>');
                                        
                                        reportDiv.appendChild(header);
                                        reportDiv.appendChild(content);
                                        reportsDiv.insertBefore(reportDiv, reportsDiv.firstChild);
                                    });
                                    
                                    // 在更新报告后，重新初始化折叠/展开功能
                                    if (typeof setupSettlementListeners === 'function') {
                                        setupSettlementListeners();
                                    }
                                }

                                // 更新round和settle_round信息
                                window.currentRound = data.round;
                                window.currentSettleRound = data.settle_round;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching room data:', error);
                    });
            }
            
            // Start polling when the page loads
            startPolling();
        });
    </script>
    <script src="{{ url_for('static', filename='js/settlement.js') }}"></script>
</body>
<footer style="width: 100%; text-align: center; font-size: 12px; color: #666; margin-top: 20px; position: relative; bottom: 0; left: 0; right: 0;">
    <p>© 2025 <a href="https://github.com/ZihaoVistonWang/scoreboard" target="_blank">赛事积分板</a> | 由 <a href="https://github.com/ZihaoVistonWang" target="_blank">王梓豪 (Zihao Viston Wang)</a> 开发 | 遵循<a href="https://github.com/ZihaoVistonWang/score-board/blob/main/LICENSE" target="_blank">MIT</a>许可开源.</p>
    {% if 'zihao' in request.host %}
    <p>
        <a href="https://beian.miit.gov.cn/" target="_blank">陕ICP备2025060869号</a>
    </p>
    {% endif %}
</footer>
</html>