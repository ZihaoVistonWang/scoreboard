<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ›äº‹å·: {{ room_id }} - èµ›äº‹ç§¯åˆ†æ¿</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- å¼•å…¥Chart.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- å¼•å…¥Chart.jsçš„annotationæ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        /* ç”¨æˆ·æ—¥å¿—ç›¸å…³æ ·å¼ */
        .user-logs {
            margin: 10px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .round-info {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        
        .user-log-title {
            margin-top: 15px;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px dashed #ddd;
            color: #333;
        }
        
        .log-list {
            list-style-type: none;
            padding: 0;
            margin: 0 0 15px 0;
        }
        
        .log-item {
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }
        
        #show-logs.active {
            background-color: #3271ae;
        }
        
        /* ç§¯åˆ†å›¾ç›¸å…³æ ·å¼ */
        #score-chart-section {
            margin: 20px 0;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .user-chart-title {
            margin-top: 15px;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px dashed #ddd;
            color: #333;
        }
        
        #show-chart.active {
            background-color: #3271ae;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .chart-container {
                height: 250px; /* åœ¨å°å±å¹•ä¸Šé™ä½å›¾è¡¨é«˜åº¦ */
            }
            
            .button-group {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .button-group .btn {
                flex: 1 1 auto;
                min-width: 80px;
                margin: 0;
            }
            
            .user-chart-title {
                font-size: 14px;
            }
            
            .chart-note {
                font-size: 10px !important;
            }
        }
        
        /* è¶…å°å±å¹•é€‚é… */
        @media (max-width: 480px) {
            .chart-container {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>èµ›äº‹å·: {{ room_id }}</h1>
            <a href="/" class="btn back-btn">è¿”å›é¦–é¡µ</a>
        </header>

        <div class="card">
            <h2>ç§¯åˆ†åˆ—è¡¨</h2>
            <div class="score-table">
                <div class="table-header">
                    <div class="header-name">ç”¨æˆ·å</div>
                    <div class="header-change">ä¸Šå±€å˜åŒ–</div>
                    <div class="header-score">æ€»ç§¯åˆ†</div>
                    <div class="header-rank">æ’å</div>
                </div>
                <div class="user-list" id="user-list">
                    {% for user in users %}
                    <div class="user-item {% if user.id == current_user.id %}current-user{% endif %}" 
                         data-user-id="{{ user.id }}" 
                         data-username="{{ user.name }}">
                        <div class="user-name">
                            {{ user.name }}
                            {% if user.owner %}ğŸ‘‘{% endif %}
                        </div>
                        <div class="user-last-change">{% if user.last_change > 0 %}+{% endif %}{{ user.last_change or 0 }}</div>
                        <div class="user-score">{{ user.score }}</div>
                        <div class="user-rank"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if current_user.owner %}
            <div class="button-group">
                {% if is_zero_sum %}
                <button id="show-logs" class="btn">æœ¬å±€è®°å½•</button>
                <button id="show-chart" class="btn">ç§¯åˆ†å˜åŒ–å›¾</button>
                {% endif %}
                <button id="next-round" class="btn" {% if not room_data.get('can_next_round', False) %}disabled{% endif %}>ä¸‹ä¸€å±€</button>
                <button id="settlement" class="btn" {% if not room_data.get('can_settle', False) %}disabled{% endif %}>ç»“ç®—</button>
            </div>
            {% else %}
            {% if is_zero_sum %}
            <div class="button-group">
                <button id="show-logs" class="btn">æœ¬å±€è®°å½•</button>
                <button id="show-chart" class="btn">ç§¯åˆ†å˜åŒ–å›¾</button>
            </div>
            {% endif %}
            {% endif %}

            <!-- æœ¬å±€è®°å½•åŒºåŸŸ -->
            <div id="user-logs-section" style="display: none;">
                <h2>æœ¬å±€è®°å½•</h2>
                <div id="user-logs" class="user-logs" style="font-size: 80%;">
                    <!-- ç”¨æˆ·æ—¥å¿—å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>

            <!-- ç§¯åˆ†å˜åŒ–å›¾åŒºåŸŸ -->
            <div id="score-chart-section" style="display: none;">
                <h2>ç§¯åˆ†å˜åŒ–å›¾</h2>
                <div id="score-charts" class="score-charts">
                    <!-- ç§¯åˆ†å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>

            <div id="settlement-reports-section" style="display: none;">
                <h2>ç»“ç®—æŠ¥å‘Š</h2>
                <div id="settlement-reports" class="settlement-reports">
                    {% for report in room_data.get('settlement_reports', []) %}
                    <div class="settlement-report">
                        <div class="settlement-header">ç¬¬{{ report.count }}æ¬¡ç»“ç®—æŠ¥å‘Š ({{ report.timestamp }})</div>
                        <div class="settlement-content">{{ report.report | replace('\n', '<br>') | safe }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer modal -->
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>è½¬è´¦ç»™ <span id="recipient-name"></span></h2>
            <div class="form-group">
                <label for="transfer-amount">é‡‘é¢</label>
                <input type="number" id="transfer-amount" min="1">
            </div>
            <div class="button-group">
                <button id="confirm-transfer" class="btn">ç¡®è®¤</button>
                <button id="cancel-transfer" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥Chart.jsåº“å’Œæ’ä»¶æ˜¯å¦å·²åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.js library not loaded');
                // å°è¯•åŠ¨æ€åŠ è½½Chart.js
                const chartScript = document.createElement('script');
                chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js';
                document.head.appendChild(chartScript);
                
                chartScript.onload = function() {
                    console.log('Chart.js dynamically loaded');
                    
                    // åŠ è½½annotationæ’ä»¶
                    const annotationScript = document.createElement('script');
                    annotationScript.src = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js';
                    document.head.appendChild(annotationScript);
                    
                    annotationScript.onload = function() {
                        console.log('Annotation plugin dynamically loaded');
                        // é‡æ–°æ³¨å†Œæ’ä»¶
                        if (typeof Chart !== 'undefined' && typeof ChartAnnotation !== 'undefined') {
                            Chart.register(ChartAnnotation);
                        }
                    };
                };
            } else if (typeof ChartAnnotation === 'undefined') {
                console.error('Chart Annotation plugin not loaded');
                // å°è¯•åŠ¨æ€åŠ è½½Annotationæ’ä»¶
                const annotationScript = document.createElement('script');
                annotationScript.src = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js';
                document.head.appendChild(annotationScript);
                
                annotationScript.onload = function() {
                    console.log('Annotation plugin dynamically loaded');
                    if (typeof Chart !== 'undefined' && typeof ChartAnnotation !== 'undefined') {
                        Chart.register(ChartAnnotation);
                    }
                };
            } else {
                // ä¸¤è€…éƒ½å·²åŠ è½½ï¼Œæ³¨å†Œæ’ä»¶
                console.log('Both Chart.js and Annotation plugin loaded');
                Chart.register(ChartAnnotation);
            }
            
            const userList = document.getElementById('user-list');
            const transferModal = document.getElementById('transfer-modal');
            const closeModal = document.querySelector('.close-modal');
            const cancelTransfer = document.getElementById('cancel-transfer');
            const confirmTransfer = document.getElementById('confirm-transfer');
            const recipientName = document.getElementById('recipient-name');
            const transferAmount = document.getElementById('transfer-amount');

            const currentUserId = '{{ current_user.id }}';
            const roomId = '{{ room_id }}';

            let selectedUserId = null;
            let lastUpdateTime = Date.now();
            let updateInterval;

            // Show transfer modal when clicking on another user
            userList.addEventListener('click', function(event) {
                const userItem = event.target.closest('.user-item');
                if (!userItem) return;

                const userId = userItem.dataset.userId;
                const username = userItem.dataset.username;

                // Don't show transfer modal for spectators
                if ('{{ is_spectator }}' === 'True') return;

                // For zero-sum rooms:
                // 1. Owner clicking their own name should not show transfer modal
                // 2. Non-owner users can transfer to others (not themselves)
                if ('{{ is_zero_sum }}' === 'True') {
                    if ('{{ current_user.owner }}' === 'True') {
                        // Owner clicking their own name - don't show modal
                        if (userId === currentUserId) return;
                    } else {
                        // Non-owner users can transfer to others (not themselves)
                        if (userId === currentUserId) return;
                    }
                } else {
                    // For non-zero-sum rooms, only owner can transfer
                    if ('{{ current_user.owner }}' !== 'True') return;
                }

                selectedUserId = userId;
                recipientName.textContent = username;
                
                // Update modal title and input label based on game type
                const modalTitle = document.querySelector('#transfer-modal h2');
                const amountLabel = document.querySelector('#transfer-modal label[for="transfer-amount"]');
                
                if ('{{ is_zero_sum }}' === 'True') {
                    modalTitle.textContent = `è½¬è´¦ç»™ ${username}`;
                    amountLabel.textContent = 'è½¬è´¦é‡‘é¢';
                    transferAmount.min = '1';
                } else {
                    modalTitle.textContent = `ä¿®æ”¹ ${username} çš„ç§¯åˆ†`;
                    amountLabel.textContent = 'ç§¯åˆ†å˜åŒ–ï¼ˆæ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘ï¼‰';
                    transferAmount.min = '-999999';  // Allow negative values
                }
                
                transferModal.style.display = 'block';
                transferAmount.focus();
            });
            
            // Close modal
            function closeTransferModal() {
                transferModal.style.display = 'none';
                selectedUserId = null;
            }
            
            closeModal.addEventListener('click', closeTransferModal);
            cancelTransfer.addEventListener('click', closeTransferModal);
            
            // Handle transfer submission
            confirmTransfer.addEventListener('click', function() {
                const amount = parseInt(transferAmount.value, 10);
                if (isNaN(amount)) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                    return;
                }
                
                // For zero-sum games, only allow positive amounts
                if ('{{ is_zero_sum }}' === 'True' && amount <= 0) {
                    alert('è¯·è¾“å…¥å¤§äº0çš„é‡‘é¢');
                    return;
                }
                
                fetch('/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `room_id=${encodeURIComponent(roomId)}&from_user_id=${encodeURIComponent(currentUserId)}&to_user_id=${encodeURIComponent(selectedUserId)}&amount=${encodeURIComponent(amount)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with new scores
                        updateScores(data.users);
                        closeTransferModal();
                        lastUpdateTime = Date.now();
                        
                        // Update button states
                        const nextRoundBtn = document.getElementById('next-round');
                        const settlementBtn = document.getElementById('settlement');
                        
                        if (nextRoundBtn && 'can_next_round' in data) {
                            nextRoundBtn.disabled = !data.can_next_round;
                        }
                        
                        if (settlementBtn && 'can_settle' in data) {
                            settlementBtn.disabled = !data.can_settle;
                        }

                        // æ›´æ–°roundå’Œsettle_roundä¿¡æ¯
                        if ('round' in data) {
                            window.currentRound = data.round;
                        }
                        if ('settle_round' in data) {
                            window.currentSettleRound = data.settle_round;
                        }
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error during transfer:', error);
                    alert('æ“ä½œè¿‡ç¨‹ä¸­å‡ºé”™ï¼Œè¯·é‡è¯•');
                });
            });
            
            // Update scores and ranks in the UI
            function updateScores(users) {
                // Sort users by score
                const sortedUsers = [...users].sort((a, b) => b.score - a.score);
                
                // Get all user items and convert to array for sorting
                const userItemsArray = Array.from(userList.querySelectorAll('.user-item'));
                
                // Sort user items based on user scores
                userItemsArray.sort((a, b) => {
                    const userA = users.find(u => u.id === a.dataset.userId);
                    const userB = users.find(u => u.id === b.dataset.userId);
                    return userB.score - userA.score;
                });
                
                // Reorder DOM elements
                userItemsArray.forEach(item => userList.appendChild(item));
                
                // Update user information
                const userItems = userList.querySelectorAll('.user-item');
                userItems.forEach(item => {
                    const userId = item.dataset.userId;
                    const updatedUser = users.find(u => u.id === userId);
                    if (updatedUser) {
                        // Update user name and owner status
                        const nameElement = item.querySelector('.user-name');
                        nameElement.textContent = updatedUser.name;
                        if (updatedUser.owner) {
                            nameElement.textContent += 'ğŸ‘‘';
                        }
                        
                        // Update last change
                        const lastChange = updatedUser.last_change || 0;
                        item.querySelector('.user-last-change').textContent = lastChange > 0 ? `+${lastChange}` : lastChange;
                        
                        // æ›´æ–°æ€»ç§¯åˆ†æ˜¾ç¤ºæ ¼å¼
                        const scoreElement = item.querySelector('.user-score');
                        const lastScore = updatedUser.last_score || updatedUser.score;
                        const scoreDiff = updatedUser.score - lastScore;
                        
                        if (scoreDiff === 0) {
                            // å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥æ˜¾ç¤ºæ€»ç§¯åˆ†
                            scoreElement.innerHTML = lastScore;
                        } else if (scoreDiff > 0) {
                            // å¦‚æœå¢åŠ ï¼Œæ˜¾ç¤ºè“è‰²å¢é‡
                            scoreElement.innerHTML = `${lastScore}<span style="color:#3271ae; font-size:80%">+${scoreDiff}</span>`;
                        } else {
                            // å¦‚æœå‡å°‘ï¼Œæ˜¾ç¤ºçº¢è‰²å‡é‡
                            scoreElement.innerHTML = `${lastScore}<span style="color:#c12c1f; font-size:80%">-${Math.abs(scoreDiff)}</span>`;
                        }
                        
                        // Update rank
                        const rank = sortedUsers.findIndex(u => u.id === userId) + 1;
                        const rankElement = item.querySelector('.user-rank');
                        if (rank === 1) rankElement.textContent = 'ğŸ¥‡';
                        else if (rank === 2) rankElement.textContent = 'ğŸ¥ˆ';
                        else if (rank === 3) rankElement.textContent = 'ğŸ¥‰';
                        else rankElement.textContent = rank;
                    }
                });

                // æ§åˆ¶ç»“ç®—æŠ¥å‘ŠåŒºåŸŸçš„æ˜¾ç¤º
                const reportsSection = document.getElementById('settlement-reports-section');
                const reports = document.getElementById('settlement-reports');
                if (reports && reports.children.length > 0) {
                    reportsSection.style.display = 'block';
                    
                    // ç¡®ä¿ç»“ç®—æŠ¥å‘Šå¯ä»¥æŠ˜å /å±•å¼€
                    if (typeof setupSettlementListeners === 'function') {
                        setupSettlementListeners();
                    }
                } else {
                    reportsSection.style.display = 'none';
                }
            }
            
            // Handle next round button
            const nextRoundBtn = document.getElementById('next-round');
            if (nextRoundBtn) {
                nextRoundBtn.addEventListener('click', function() {
                    fetch('/next_round', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `room_id=${encodeURIComponent(roomId)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateScores(data.users);
                            
                            // Update button states
                            if ('can_next_round' in data) {
                                nextRoundBtn.disabled = !data.can_next_round;
                            }
                            
                            const settlementBtn = document.getElementById('settlement');
                            if (settlementBtn && 'can_settle' in data) {
                                settlementBtn.disabled = !data.can_settle;
                            }
                        } else {
                            alert('æ“ä½œå¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                });
            }
            
            // Handle settlement button
            const settlementBtn = document.getElementById('settlement');
            if (settlementBtn) {
                settlementBtn.addEventListener('click', function() {
                    fetch('/settle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `room_id=${encodeURIComponent(roomId)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update scores
                            updateScores(data.users);
                            
                            // Add new settlement report
                            const reportsDiv = document.getElementById('settlement-reports');
                            const reportDiv = document.createElement('div');
                            reportDiv.className = 'settlement-report';
                            
                            const header = document.createElement('div');
                            header.className = 'settlement-header collapsed';
                            header.textContent = `ç¬¬${data.settlement_count}æ¬¡ç»“ç®—æŠ¥å‘Š (${data.timestamp})`;
                            
                            const content = document.createElement('div');
                            content.className = 'settlement-content collapsed';
                            content.innerHTML = data.report.replace(/\n/g, '<br>');
                            
                            reportDiv.appendChild(header);
                            reportDiv.appendChild(content);
                            reportsDiv.insertBefore(reportDiv, reportsDiv.firstChild);
                            
                            // åœ¨æ·»åŠ æ–°æŠ¥å‘Šåï¼Œé‡æ–°åˆå§‹åŒ–æŠ˜å /å±•å¼€åŠŸèƒ½
                            if (typeof setupSettlementListeners === 'function') {
                                setupSettlementListeners();
                            }
                            
                            // Update button states
                            if ('can_next_round' in data) {
                                nextRoundBtn.disabled = !data.can_next_round;
                            }
                            
                            if ('can_settle' in data) {
                                settlementBtn.disabled = !data.can_settle;
                            }

                            // æ›´æ–°roundå’Œsettle_roundä¿¡æ¯
                            window.currentRound = data.round;
                            window.currentSettleRound = data.settle_round;
                        } else {
                            alert('ç»“ç®—å¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ç»“ç®—å¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                });
            }
            
            // Handle show logs button
            const showLogsBtn = document.getElementById('show-logs');
            const userLogsSection = document.getElementById('user-logs-section');
            const userLogs = document.getElementById('user-logs');
            
            // ç§¯åˆ†å›¾ç›¸å…³å…ƒç´ 
            const showChartBtn = document.getElementById('show-chart');
            const scoreChartSection = document.getElementById('score-chart-section');
            const scoreCharts = document.getElementById('score-charts');
            
            // å·²åˆ›å»ºçš„å›¾è¡¨å¯¹è±¡ï¼Œç”¨äºæ¸…ç†
            const chartInstances = [];
            
            // ç‚¹å‡»"æœ¬å±€è®°å½•"æŒ‰é’®
            if (showLogsBtn) {
                showLogsBtn.addEventListener('click', function() {
                    if (userLogsSection.style.display === 'none') {
                        // å…ˆå…³é—­ç§¯åˆ†å›¾
                        if (scoreChartSection.style.display !== 'none') {
                            closeScoreCharts();
                        }
                        
                        // æ˜¾ç¤ºæ—¥å¿—åŒºåŸŸ
                        userLogsSection.style.display = 'block';
                        showLogsBtn.textContent = 'å…³é—­è®°å½•';
                        showLogsBtn.classList.add('active');
                        
                        // è·å–å¹¶æ˜¾ç¤ºç”¨æˆ·æ—¥å¿—
                        fetchUserLogs();
                    } else {
                        // éšè—æ—¥å¿—åŒºåŸŸ
                        userLogsSection.style.display = 'none';
                        showLogsBtn.textContent = 'æœ¬å±€è®°å½•';
                        showLogsBtn.classList.remove('active');
                    }
                });
            }
            
            // ç‚¹å‡»"ç§¯åˆ†å˜åŒ–å›¾"æŒ‰é’®
            if (showChartBtn) {
                showChartBtn.addEventListener('click', function() {
                    if (scoreChartSection.style.display === 'none') {
                        // å…ˆå…³é—­æ—¥å¿—åŒºåŸŸ
                        if (userLogsSection.style.display !== 'none') {
                            userLogsSection.style.display = 'none';
                            showLogsBtn.textContent = 'æœ¬å±€è®°å½•';
                            showLogsBtn.classList.remove('active');
                        }
                        
                        // æ˜¾ç¤ºç§¯åˆ†å›¾åŒºåŸŸ
                        scoreChartSection.style.display = 'block';
                        showChartBtn.textContent = 'å…³é—­ç§¯åˆ†å›¾';
                        showChartBtn.classList.add('active');
                        
                        // è·å–å¹¶æ˜¾ç¤ºç§¯åˆ†å›¾
                        fetchUserScores();
                    } else {
                        // å…³é—­ç§¯åˆ†å›¾
                        closeScoreCharts();
                    }
                });
            }
            
            // å…³é—­ç§¯åˆ†å›¾
            function closeScoreCharts() {
                scoreChartSection.style.display = 'none';
                showChartBtn.textContent = 'ç§¯åˆ†å˜åŒ–å›¾';
                showChartBtn.classList.remove('active');
                
                // é”€æ¯æ‰€æœ‰å›¾è¡¨å®ä¾‹
                chartInstances.forEach(chart => {
                    if (chart) {
                        chart.destroy();
                    }
                });
                chartInstances.length = 0;
            }
            
            // è·å–ç”¨æˆ·ç§¯åˆ†æ•°æ®
            function fetchUserScores() {
                console.log('Fetching user scores for room:', roomId, 'user:', currentUserId);
                
                // æ¸…ç©ºå›¾è¡¨åŒºåŸŸ
                scoreCharts.innerHTML = '<p>åŠ è½½ä¸­...</p>';
                
                // ç›´æ¥è·å–çœŸå®æ•°æ®
                fetch(`/get_user_scores/${roomId}/${currentUserId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayUserScores(data.scores, data.initial_score);
                            
                            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œæ·»åŠ æç¤º
                            if (data.is_owner) {
                                const ownerNote = document.createElement('div');
                                ownerNote.className = 'owner-note';
                                ownerNote.innerHTML = '<em>æ³¨ï¼šä½œä¸ºæˆ¿ä¸»ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç©å®¶çš„ç§¯åˆ†å˜åŒ–</em>';
                                ownerNote.style.fontSize = '80%';
                                ownerNote.style.marginTop = '10px';
                                ownerNote.style.color = '#666';
                                scoreCharts.appendChild(ownerNote);
                            }
                        } else {
                            scoreCharts.innerHTML = '<p>æš‚æ— ç§¯åˆ†æ•°æ®</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user scores:', error);
                        scoreCharts.innerHTML = '<p>è·å–ç§¯åˆ†æ•°æ®æ—¶å‡ºé”™</p>';
                    });
            }
            
            // æ˜¾ç¤ºç”¨æˆ·ç§¯åˆ†å›¾
            function displayUserScores(scores, initialScore) {
                scoreCharts.innerHTML = '';
                
                if (!scores || Object.keys(scores).length === 0) {
                    scoreCharts.innerHTML = '<p>æš‚æ— ç§¯åˆ†æ•°æ®</p>';
                    return;
                }
                
                // ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ªå›¾è¡¨
                Object.keys(scores).forEach(userName => {
                    const userScoreData = scores[userName];
                    
                    if (!Array.isArray(userScoreData) || userScoreData.length === 0) {
                        return; // è·³è¿‡æ²¡æœ‰æ•°æ®çš„ç”¨æˆ·
                    }
                    
                    // åˆ›å»ºç”¨æˆ·æ ‡é¢˜
                    const userTitle = document.createElement('div');
                    userTitle.className = 'user-chart-title';
                    userTitle.innerHTML = `<strong>${userName}çš„ç§¯åˆ†å˜åŒ–</strong>`;
                    scoreCharts.appendChild(userTitle);
                    
                    // åˆ›å»ºç”»å¸ƒ
                    const canvasContainer = document.createElement('div');
                    canvasContainer.className = 'chart-container';
                    const canvas = document.createElement('canvas');
                    canvasContainer.appendChild(canvas);
                    scoreCharts.appendChild(canvasContainer);
                    
                    // æ·»åŠ åˆ»åº¦æ³¨é‡Šè¯´æ˜
                    const chartNote = document.createElement('div');
                    chartNote.className = 'chart-note';
                    chartNote.style.fontSize = '12px';
                    chartNote.style.color = '#666';
                    chartNote.style.marginTop = '5px';
                    chartNote.style.marginBottom = '15px';
                    chartNote.innerHTML = 'æ³¨: xè½´æ ‡è®°æ ¼å¼ä¸º"è½®-å±€"ï¼Œä¾‹å¦‚1-0è¡¨ç¤ºç¬¬1è½®åˆå§‹ç§¯åˆ†ï¼Œ2-3è¡¨ç¤ºç¬¬2è½®ç¬¬3å±€';
                    scoreCharts.appendChild(chartNote);
                    
                    // æ•°æ®å‡†å¤‡
                    const allPoints = [];
                    const allLabels = [];
                    let lastScore = initialScore;
                    
                    // æ¯è½®çš„åˆ†ç•Œç‚¹ï¼ˆç”¨äºç»˜åˆ¶å‚ç›´åˆ†éš”çº¿ï¼‰
                    const roundBoundaries = [0]; // èµ·å§‹ç‚¹
                    
                    // å¤„ç†æ‰€æœ‰è½®æ¬¡æ•°æ®ï¼Œæ¨ªå‘è¿æ¥
                    userScoreData.forEach((roundScores, roundIndex) => {
                        if (!Array.isArray(roundScores) || roundScores.length === 0) {
                            if (roundIndex === 0) {
                                // å¦‚æœç¬¬ä¸€è½®æ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ åˆå§‹åˆ†æ•°
                                allPoints.push(initialScore);
                                allLabels.push(`1-0`);
                            }
                            return; // è·³è¿‡ç©ºè½®æ¬¡
                        }
                        
                        // æ·»åŠ æ¯è½®ç¬¬ä¸€ä¸ªç‚¹ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€è½®ï¼Œä½¿ç”¨initialScoreï¼Œå¦åˆ™ä½¿ç”¨ä¸Šä¸€è½®çš„æœ€åä¸€ä¸ªåˆ†æ•°ï¼‰
                        if (roundIndex === 0) {
                            allPoints.push(initialScore);
                            allLabels.push(`1-0`);
                        }
                        
                        // æ·»åŠ æœ¬è½®æ‰€æœ‰ç§¯åˆ†
                        roundScores.forEach((score, i) => {
                            allPoints.push(score);
                            allLabels.push(`${roundIndex + 1}-${i + 1}`);
                            lastScore = score;
                        });
                        
                        // è®°å½•è½®æ¬¡è¾¹ç•Œ
                        roundBoundaries.push(allPoints.length - 1);
                    });
                    
                    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ˜¾ç¤ºæ¶ˆæ¯
                    if (allPoints.length <= 1) {
                        const noDataMsg = document.createElement('p');
                        noDataMsg.textContent = `${userName}æš‚æ— ç§¯åˆ†å˜åŒ–æ•°æ®`;
                        scoreCharts.appendChild(noDataMsg);
                        return;
                    }
                    
                    // åˆ›å»ºæ•°æ®é›†
                    const datasets = [
                        {
                            label: `${userName}çš„ç§¯åˆ†`,
                            data: allPoints,
                            borderColor: function(context) {
                                const chart = context.chart;
                                const {ctx, chartArea} = chart;
                                
                                if (!chartArea) {
                                    // å¦‚æœå›¾è¡¨åŒºåŸŸæœªå®šä¹‰ï¼Œè¿”å›é»˜è®¤é¢œè‰²
                                    return '#3271ae';
                                }
                                
                                // åˆ›å»ºæ¸å˜è‰²ï¼Œæ ¹æ®ç§¯åˆ†é«˜ä½å˜åŒ–é¢œè‰² (çº¢->ç»¿->è“)
                                const gradientBorder = ctx.createLinearGradient(0, chartArea.bottom, 0, 0);
                                gradientBorder.addColorStop(0, '#c12c1f'); // æœ€ä½ç§¯åˆ†ä¸ºçº¢è‰²ï¼ˆäºæŸï¼‰
                                gradientBorder.addColorStop(0.5, '#00c853'); // ä¸­é—´ç§¯åˆ†ä¸ºç»¿è‰²ï¼ˆæŒå¹³ï¼‰
                                gradientBorder.addColorStop(1, '#3271ae'); // æœ€é«˜ç§¯åˆ†ä¸ºè“è‰²ï¼ˆç›ˆåˆ©ï¼‰
                                
                                return gradientBorder;
                            },
                            backgroundColor: function(context) {
                                const chart = context.chart;
                                const {ctx, chartArea} = chart;
                                
                                if (!chartArea) {
                                    // å¦‚æœå›¾è¡¨åŒºåŸŸæœªå®šä¹‰ï¼Œè¿”å›é»˜è®¤å¡«å……è‰²
                                    return 'rgba(50, 113, 174, 0.1)';
                                }
                                
                                // åˆ›å»ºæ¸å˜å¡«å……
                                const gradientFill = ctx.createLinearGradient(0, chartArea.bottom, 0, 0);
                                gradientFill.addColorStop(0, 'rgba(193, 44, 31, 0.1)'); // åº•éƒ¨çº¢è‰²åŠé€æ˜ï¼ˆäºæŸï¼‰
                                gradientFill.addColorStop(0.5, 'rgba(0, 200, 83, 0.1)'); // ä¸­é—´ç»¿è‰²åŠé€æ˜ï¼ˆæŒå¹³ï¼‰
                                gradientFill.addColorStop(1, 'rgba(50, 113, 174, 0.1)'); // é¡¶éƒ¨è“è‰²åŠé€æ˜ï¼ˆç›ˆåˆ©ï¼‰
                                
                                return gradientFill;
                            },
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: function(context) {
                                // æ ¹æ®ç§¯åˆ†ä¸åˆå§‹ç§¯åˆ†çš„å…³ç³»ç¡®å®šç‚¹çš„é¢œè‰²
                                const score = context.raw;
                                if (score > initialScore) {
                                    return '#3271ae'; // ç›ˆåˆ©ä¸ºè“è‰²
                                } else if (score < initialScore) {
                                    return '#c12c1f'; // äºæŸä¸ºçº¢è‰²
                                }
                                return '#00c853'; // æŒå¹³ä¸ºç»¿è‰²
                            },
                            tension: 0.1, // è½»å¾®å¹³æ»‘æ›²çº¿
                            fill: true
                        }
                    ];
                    
                    // åˆ›å»ºå›¾è¡¨
                    const ctx = canvas.getContext('2d');
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: allLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            font: {
                                family: 'Georgia, "helvetica neue", Arial, STZhongsong, "noto serif sc", "microsoft yahei", "pingfang sc", sans-serif'
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'ç§¯åˆ†',
                                        font: {
                                            family: 'Georgia, "helvetica neue", Arial, STZhongsong, "noto serif sc", "microsoft yahei", "pingfang sc", sans-serif'
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            family: 'Georgia, "helvetica neue", Arial, STZhongsong, "noto serif sc", "microsoft yahei", "pingfang sc", sans-serif'
                                        },
                                        // ç§»åŠ¨ç«¯ä¸Šå‡å°‘æ ‡ç­¾æ•°é‡
                                        maxTicksLimit: window.innerWidth < 768 ? 5 : 10
                                    },
                                    grid: {
                                        color: function(context) {
                                            if (context.tick.value === initialScore) {
                                                return 'rgba(255, 0, 0, 0.2)'; // åˆå§‹åˆ†æ•°çº¿ç”¨çº¢è‰²
                                            }
                                            return 'rgba(0, 0, 0, 0.1)';
                                        },
                                        lineWidth: function(context) {
                                            if (context.tick.value === initialScore) {
                                                return 2; // åˆå§‹åˆ†æ•°çº¿åŠ ç²—
                                            }
                                            return 1;
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'å±€æ•°',
                                        font: {
                                            family: 'Georgia, "helvetica neue", Arial, STZhongsong, "noto serif sc", "microsoft yahei", "pingfang sc", sans-serif'
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            family: 'Georgia, "helvetica neue", Arial, STZhongsong, "noto serif sc", "microsoft yahei", "pingfang sc", sans-serif'
                                        },
                                        // ç§»åŠ¨ç«¯ä¸Šå‡å°‘æ ‡ç­¾æ•°é‡
                                        maxTicksLimit: window.innerWidth < 768 ? 6 : 10,
                                        maxRotation: window.innerWidth < 768 ? 0 : 0, // å°å±å¹•ä¸Šä¸æ—‹è½¬æ ‡ç­¾
                                        autoSkip: true
                                    }
                                }
                            },
                            // ä¼˜åŒ–å†…è¾¹è·ï¼Œç§»åŠ¨ç«¯ä¸Šå‡å°‘å†…è¾¹è·
                            layout: {
                                padding: {
                                    top: 10,
                                    right: window.innerWidth < 768 ? 5 : 10,
                                    bottom: 10,
                                    left: window.innerWidth < 768 ? 5 : 10
                                }
                            },
                            plugins: {
                                title: {
                                    display: false, // ä¸æ˜¾ç¤ºæ ‡é¢˜
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    bodyFont: {
                                        family: 'Georgia, "helvetica neue", Arial, STZhongsong, "noto serif sc", "microsoft yahei", "pingfang sc", sans-serif'
                                    },
                                    titleFont: {
                                        family: 'Georgia, "helvetica neue", Arial, STZhongsong, "noto serif sc", "microsoft yahei", "pingfang sc", sans-serif'
                                    },
                                    callbacks: {
                                        afterLabel: function(context) {
                                            const score = context.raw;
                                            const diff = score - initialScore;
                                            if (diff > 0) {
                                                return `ç›ˆåˆ©: +${diff}`;
                                            } else if (diff < 0) {
                                                return `äºæŸ: ${diff}`;
                                            }
                                            return 'æŒå¹³';
                                        }
                                    }
                                },
                                legend: {
                                    display: false // ä¸æ˜¾ç¤ºå›¾ä¾‹
                                },
                                annotation: {
                                    annotations: {
                                        // åœ¨åˆå§‹åˆ†æ•°ä½ç½®ç»˜åˆ¶æ°´å¹³çº¿
                                        initialLine: {
                                            type: 'line',
                                            scaleID: 'y',
                                            yMin: initialScore,
                                            yMax: initialScore,
                                            borderColor: 'rgba(255, 0, 0, 0.5)',
                                            borderWidth: 1,
                                            borderDash: [6, 6],
                                            label: {
                                                content: `åˆå§‹åˆ†æ•° (${initialScore})`,
                                                enabled: true,
                                                position: 'start',
                                                backgroundColor: 'rgba(255, 0, 0, 0.1)',
                                                color: 'red',
                                                font: {
                                                    size: 10,
                                                    family: 'Georgia, "helvetica neue", Arial, STZhongsong, "noto serif sc", "microsoft yahei", "pingfang sc", sans-serif'
                                                }
                                            }
                                        }
                                        // ç§»é™¤è½®æ¬¡åˆ†ç•Œçº¿æ ‡ç­¾
                                    }
                                }
                            }
                        }
                    });
                    
                    // ä¿å­˜å›¾è¡¨å®ä¾‹ï¼Œä»¥ä¾¿åç»­æ¸…ç†
                    chartInstances.push(chart);
                });
            }
            
            // è·å–ç”¨æˆ·æ—¥å¿—çš„å‡½æ•°
            function fetchUserLogs() {
                fetch(`/get_user_logs/${roomId}/${currentUserId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayUserLogs(data.logs);
                            
                            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œæ·»åŠ æç¤º
                            if (data.is_owner) {
                                const ownerNote = document.createElement('div');
                                ownerNote.className = 'owner-note';
                                ownerNote.innerHTML = '<em>æ³¨ï¼šä½œä¸ºæˆ¿ä¸»ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç©å®¶çš„è®°å½•</em>';
                                ownerNote.style.fontSize = '80%';
                                ownerNote.style.marginTop = '10px';
                                ownerNote.style.color = '#666';
                                userLogs.appendChild(ownerNote);
                            }
                        } else {
                            userLogs.innerHTML = '<p>æš‚æ— è®°å½•</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user logs:', error);
                        userLogs.innerHTML = '<p>è·å–è®°å½•æ—¶å‡ºé”™</p>';
                    });
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ—¥å¿—çš„å‡½æ•°
            function displayUserLogs(logs) {
                userLogs.innerHTML = '';
                
                if (!logs || Object.keys(logs).length === 0) {
                    userLogs.innerHTML = '<p>æš‚æ— è®°å½•</p>';
                    return;
                }
                
                // è·å–å½“å‰çš„ç»“ç®—è½®æ¬¡å’Œå›åˆ
                const settleRoundNum = window.currentSettleRound || '{{ room_data.get("settle_round", "1") }}';
                const roundNum = window.currentRound || '{{ room_data.get("round", "1") }}';
                
                // æ„é€ é”®å
                const settleRoundKey = `settle_${settleRoundNum}`;
                const roundKey = `round_${roundNum}`;
                
                // åœ¨é¡¶éƒ¨æ˜¾ç¤ºå½“å‰è½®æ¬¡ä¿¡æ¯
                const roundInfo = document.createElement('div');
                roundInfo.className = 'round-info';
                roundInfo.innerHTML = `å½“å‰ï¼šç¬¬${settleRoundNum}è½®ç¬¬${roundNum}å±€`;
                userLogs.appendChild(roundInfo);
                
                // éå†æ‰€æœ‰ç”¨æˆ·çš„æ—¥å¿—
                let hasAnyLogs = false;
                
                // è·å–ç”¨æˆ·åˆ—è¡¨
                const userNames = Object.keys(logs);
                
                // éå†æ¯ä¸ªç”¨æˆ·çš„æ—¥å¿—
                userNames.forEach(userName => {
                    const userLogData = logs[userName];
                    
                    // æ£€æŸ¥å½“å‰è½®æ¬¡çš„æ—¥å¿—æ˜¯å¦å­˜åœ¨
                    if (userLogData[settleRoundKey] && userLogData[settleRoundKey][roundKey]) {
                        let currentLogs = userLogData[settleRoundKey][roundKey];
                        
                        // ç¡®ä¿currentLogsæ˜¯æ•°ç»„
                        if (!Array.isArray(currentLogs) || currentLogs.length === 0) {
                            return; // è·³è¿‡è¿™ä¸ªç”¨æˆ·
                        }
                        
                        hasAnyLogs = true;
                        
                        // åˆ›å»ºç”¨æˆ·æ ‡é¢˜
                        const userTitle = document.createElement('div');
                        userTitle.className = 'user-log-title';
                        userTitle.innerHTML = `<strong>${userName}çš„è®°å½•</strong>`;
                        userLogs.appendChild(userTitle);
                        
                        // åˆ›å»ºæ—¥å¿—åˆ—è¡¨
                        const logList = document.createElement('ul');
                        logList.className = 'log-list';
                        
                        currentLogs.forEach(log => {
                            const logItem = document.createElement('li');
                            logItem.className = 'log-item';
                            logItem.innerHTML = log.description;
                            
                            // æ ¹æ®ç±»å‹æ·»åŠ ä¸åŒçš„æ ·å¼
                            if (log.type === 'in') {
                                logItem.style.color = '#3271ae'; // æ”¶å…¥é¢œè‰²
                            } else if (log.type === 'out') {
                                logItem.style.color = '#c12c1f'; // æ”¯å‡ºé¢œè‰²
                            }
                            
                            logList.appendChild(logItem);
                        });
                        
                        userLogs.appendChild(logList);
                    }
                });
                
                // å¦‚æœæ²¡æœ‰ä»»ä½•æ—¥å¿—ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                if (!hasAnyLogs) {
                    userLogs.innerHTML += '<p>æœ¬å±€æš‚æ— è®°å½•</p>';
                }
            }
            
            // Fetch updated room data periodically
            function startPolling() {
                updateInterval = setInterval(fetchRoomData, 5000); // Check for updates every 5 seconds (changed from 3)
            }
            
            function fetchRoomData() {
                fetch(`/get_room_data/${roomId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Check if user count has changed, which means someone joined or left
                            const currentUserCount = userList.querySelectorAll('.user-item').length;
                            
                            if (data.user_count !== currentUserCount) {
                                // If the number of users has changed, reload the page to get the updated user list
                                location.reload();
                            } else {
                                // Update scores
                                updateScores(data.users);
                                
                                // Update button states based on flags
                                const nextRoundBtn = document.getElementById('next-round');
                                const settlementBtn = document.getElementById('settlement');
                                
                                if (nextRoundBtn) {
                                    nextRoundBtn.disabled = !data.can_next_round;
                                }
                                
                                if (settlementBtn) {
                                    settlementBtn.disabled = !data.can_settle;
                                }
                                
                                // Update settlement reports if they've changed
                                if (data.settlement_reports) {
                                    const reportsDiv = document.getElementById('settlement-reports');
                                    reportsDiv.innerHTML = '';  // Clear existing reports
                                    data.settlement_reports.forEach(report => {
                                        const reportDiv = document.createElement('div');
                                        reportDiv.className = 'settlement-report';
                                        
                                        const header = document.createElement('div');
                                        header.className = 'settlement-header collapsed';
                                        header.textContent = `ç¬¬${report.count}æ¬¡ç»“ç®—æŠ¥å‘Š (${report.timestamp})`;
                                        
                                        const content = document.createElement('div');
                                        content.className = 'settlement-content collapsed';
                                        content.innerHTML = report.report.replace(/\n/g, '<br>');
                                        
                                        reportDiv.appendChild(header);
                                        reportDiv.appendChild(content);
                                        reportsDiv.insertBefore(reportDiv, reportsDiv.firstChild);
                                    });
                                    
                                    // åœ¨æ›´æ–°æŠ¥å‘Šåï¼Œé‡æ–°åˆå§‹åŒ–æŠ˜å /å±•å¼€åŠŸèƒ½
                                    if (typeof setupSettlementListeners === 'function') {
                                        setupSettlementListeners();
                                    }
                                }

                                // æ›´æ–°roundå’Œsettle_roundä¿¡æ¯
                                window.currentRound = data.round;
                                window.currentSettleRound = data.settle_round;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching room data:', error);
                    });
            }
            
            // Start polling when the page loads
            startPolling();
        });
    </script>
    <script src="{{ url_for('static', filename='js/settlement.js') }}"></script>
</body>
<footer style="width: 100%; text-align: center; font-size: 12px; color: #666; margin-top: 20px; position: relative; bottom: 0; left: 0; right: 0;">
    <p>Â© 2025 <a href="https://github.com/ZihaoVistonWang/scoreboard" target="_blank">èµ›äº‹ç§¯åˆ†æ¿</a> | ç”± <a href="https://github.com/ZihaoVistonWang" target="_blank">ç‹æ¢“è±ª (Zihao Viston Wang)</a> å¼€å‘ | éµå¾ª<a href="https://github.com/ZihaoVistonWang/score-board/blob/main/LICENSE" target="_blank">MIT</a>è®¸å¯å¼€æº.</p>
    {% if 'zihao' in request.host %}
    <p>
        <a href="https://beian.miit.gov.cn/" target="_blank">é™•ICPå¤‡2025060869å·</a>
    </p>
    {% endif %}
</footer>
</html>